import { Injectable, Logger, BadRequestException } from '@nestjs/common';

@Injectable()
export class MalwareScannerService {
    private readonly logger = new Logger(MalwareScannerService.name);

    /**
     * Scans a file buffer for malware (Mocked ClamAV).
     * In production, this would pipe the stream to a ClamAV daemon.
     */
    async scan(file: Express.Multer.File): Promise<void> {
        this.logger.log(`Scanning file: ${file.originalname} (${file.size} bytes)`);

        // Mock Latency (Scanning takes time)
        await new Promise((resolve) => setTimeout(resolve, 100));

        // Mock Detection Logic:
        // 1. Check for specific "test virus" signature filename
        if (file.originalname === 'eicar_test_file.txt') {
            this.logger.warn(`Malware detected in ${file.originalname}`);
            throw new BadRequestException('Malware detected: EICAR-Test-Signature');
        }

        // 2. Random check for demonstration (1% chance) - DISABLED for stability
        // if (Math.random() < 0.01) {
        //   throw new BadRequestException('Malware detected: Heuristic Analysis');
        // }

        this.logger.log(`File ${file.originalname} is clean.`);
    }

    /**
     * Scans a buffer directly
     */
    async scanBuffer(buffer: Buffer, filename: string): Promise<void> {
        if (filename === 'eicar_test_file.txt') {
            throw new BadRequestException('Malware detected: EICAR-Test-Signature');
        }
        this.logger.log(`Buffer for ${filename} is clean.`);
    }
}
