generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
  binaryTargets   = ["native", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["payments"]
}

model Wallet {
  id                      String        @id @default(uuid())
  userId                  String        @unique
  balance                 Decimal       @default(0.00)
  currency                String        @default("USD")
  preferredCurrency       String        @default("USD")
  cryptoAddress           String?
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  autoWithdrawalEnabled   Boolean       @default(false)
  autoWithdrawalSchedule  String?
  autoWithdrawalThreshold Decimal?
  pendingBalance          Decimal       @default(0.00)
  autoWithdrawalMethodId  String?
  
  // Auto-deposit (Client)
  autoDepositEnabled      Boolean       @default(false)
  autoDepositThreshold    Decimal?
  autoDepositAmount       Decimal?
  paymentMethodId         String?
  connectsBalance         Int           @default(10) // Initial connects for new users

  transactions            Transaction[]

  @@schema("payments")
}

model PaymentMethod {
  id        String   @id @default(uuid())
  userId    String
  type      String   // e.g., "CREDIT_CARD"
  last4     String?
  brand     String?
  token     String   // Provider token
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("payments")
}

model Transaction {
  id          String    @id @default(uuid())
  walletId    String
  amount      Decimal
  type        String
  status      String
  referenceId String?
  departmentId String?
  costCenter   String?
  description String?
  createdAt   DateTime  @default(now())
  clearedAt   DateTime?
  feeAmount   Decimal   @default(0.0)
  invoiceId   String?
  taxAmount   Decimal   @default(0.0)
  invoice     Invoice?  @relation(fields: [invoiceId], references: [id])
  wallet      Wallet    @relation(fields: [walletId], references: [id])
  approvalParams PaymentApprovalRequest?

  @@schema("payments")
}

model PaymentApprovalRequest {
  id            String      @id @default(uuid())
  transactionId String      @unique
  transaction   Transaction @relation(fields: [transactionId], references: [id])
  status        String      @default("PENDING") // PENDING, APPROVED, REJECTED
  requestedBy   String      // User ID
  decidedBy     String?     // User ID
  decidedAt     DateTime?
  reason        String?
  requiredRoles String[]    @default([])
  approvals     Json?       @default("[]") // Array of { role, userId, approvedAt }
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@schema("payments")
}

model Invoice {
  id            String        @id @default(uuid())
  invoiceNumber String        @unique
  senderId      String
  receiverId    String
  amount        Decimal
  taxAmount     Decimal       @default(0.0)
  feeAmount     Decimal       @default(0.0)
  currency      String        @default("USD")
  status        String        @default("UNPAID")
  dueDate       DateTime?
  paidAt        DateTime?
  items         Json
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  transactions  Transaction[]

  @@schema("payments")
}

model ConnectsHistory {
  id        String   @id @default(uuid())
  userId    String
  amount    Int
  type      String
  reason    String?
  createdAt DateTime @default(now())

  @@schema("payments")
}

model TaxSetting {
  id          String   @id @default(uuid())
  countryCode String   @unique
  taxRate     Decimal  // Default/Flat rate
  name        String
  brackets    Json?    // Optional: Array of { min, max, rate }
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@schema("payments")
}

model WithdrawalMethod {
  id            String   @id @default(uuid())
  userId        String
  type          String
  provider      String?
  accountNumber String
  accountName   String
  isDefault     Boolean  @default(false)
  isInstantCapable Boolean @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@schema("payments")
}

model Subscription {
  id              String   @id @default(uuid())
  userId          String   @unique
  planId          String
  price           Decimal
  status          String   @default("ACTIVE")
  nextBillingDate DateTime
  autoRenew       Boolean  @default(true)
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@schema("payments")
}

model EscrowHold {
  id            String   @id @default(uuid())
  walletId      String   // Client's wallet
  transactionId String   @unique // Link to the funding transaction
  contractId    String
  milestoneId   String
  amount        Decimal
  currency      String   @default("USD")
  costCenter    String?
  status        String   @default("HELD") // HELD, RELEASED, REFUNDED
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@schema("payments")
}

model Payroll {
  id              String           @id @default(uuid())
  contractId      String
  employeeId      String
  periodStart     DateTime
  periodEnd       DateTime
  grossAmount     Decimal
  taxAmount       Decimal
  benefitsAmount  Decimal
  netAmount       Decimal
  status          String           @default("PENDING") // PENDING, PAID, FAILED
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  payrollBenefits PayrollBenefit[]

  @@schema("payments")
}

model BenefitPlan {
  id              String           @id @default(uuid())
  name            String
  type            String           // HEALTH, RETIREMENT, GYM, etc.
  provider        String?
  monthlyCost     Decimal
  employerShare   Decimal          // Percentage or Fixed amount - let's assume percentage
  isActive        Boolean          @default(true)
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  payrollBenefits PayrollBenefit[]

  @@schema("payments")
}

model PayrollBenefit {
  id            String      @id @default(uuid())
  payrollId     String
  benefitPlanId String
  amount        Decimal     // The calculated amount for this specific payroll
  payroll       Payroll     @relation(fields: [payrollId], references: [id])
  benefitPlan   BenefitPlan @relation(fields: [benefitPlanId], references: [id])

  @@schema("payments")
}
