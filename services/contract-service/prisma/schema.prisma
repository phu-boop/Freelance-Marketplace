generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
  binaryTargets   = ["native", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  url      = env("DATABASE_URL")
  schemas  = ["contracts"]
}

model Contract {
  id            String   @id @default(uuid())
  job_id        String   // Job ID from Job Service
  freelancer_id String   // User ID from User Service
  client_id     String   // User ID from User Service
  proposal_id   String   // Proposal ID from Proposal Service
  agencyId      String?  // Optional: linked agency/team ID
  departmentId  String?  // Optional: linked department ID
  totalAmount   Decimal
  status        String   @default("ACTIVE") // ACTIVE, COMPLETED, TERMINATED, DISPUTED, PENDING_APPROVAL
  type          String   @default("FREELANCE") // FREELANCE, EOR
  eorFeePercentage Decimal @default(5.0)
  startDate     DateTime @default(now())
  endDate       DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  // Escrow
  escrowStatus  String   @default("PENDING") // PENDING, FUNDED, RELEASED, REFUNDED
  escrowAmount  Decimal  @default(0.0)
  
  // Template
  templateUrl   String?
  customClauses Json?    // Array of { title, content }

  // Relations
  milestones    Milestone[]
  timeLogs      TimeLog[]
  timeSessions  TimeSession[]
  disputes      Dispute[]
  checkIns      CheckIn[]
  workspaces    Workspace[]
  arbitrationCases ArbitrationCase[]
  approvalParams ContractApprovalRequest?
  disputeStatus String?
  disputeReason String?
  autoReleaseDays Int @default(14)

  // Insurance
  insurancePolicyId String?
  insurancePolicy   InsurancePolicy? @relation(fields: [insurancePolicyId], references: [id])

  @@schema("contracts")
}

model ContractApprovalRequest {
  id          String   @id @default(uuid())
  contractId  String   @unique
  contract    Contract @relation(fields: [contractId], references: [id])
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  requestedBy String   // User ID
  decidedBy   String?  // User ID
  decidedAt   DateTime?
  reason      String?  // Rejection reason
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@schema("contracts")
}

model InsurancePolicy {
  id              String   @id @default(uuid())
  contractId      String   @unique
  provider        String   // Bunker, Next Insurance
  coverageAmount  Decimal
  premiumAmount   Decimal
  status          String   @default("ACTIVE") // ACTIVE, EXPIRED, CANCELLED
  startDate       DateTime @default(now())
  endDate         DateTime
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  contracts       Contract[]

  @@schema("contracts")
}

model Workspace {
  id         String   @id @default(uuid())
  contractId String
  contract   Contract @relation(fields: [contractId], references: [id])
  content    Json     @default("{}")
  version    Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@unique([contractId])
  @@schema("contracts")
}

model CheckIn {
  id          String   @id @default(uuid())
  contractId  String
  contract    Contract @relation(fields: [contractId], references: [id])
  title       String
  description String?
  scheduledAt DateTime
  durationMinutes Int @default(30)
  status      String   @default("SCHEDULED") // SCHEDULED, COMPLETED, CANCELLED
  meetingLink String?   // Jitsi Meet link
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@schema("contracts")
}

model Dispute {
  id            String   @id @default(uuid())
  contractId    String
  contract      Contract @relation(fields: [contractId], references: [id])
  raisedById    String   // User ID who raised the dispute
  reason        String
  evidence      String[] // URLs to files
  status        String   @default("OPEN") // OPEN, UNDER_REVIEW, RESOLVED, CLOSED
  resolution    String?  // Final decision text
  resolvedAt    DateTime?
  disputeTimeoutAt DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@schema("contracts")
}

model TimeLog {
  id          String   @id @default(uuid())
  contractId  String
  contract    Contract @relation(fields: [contractId], references: [id])
  hours       Decimal
  description String
  date        DateTime
  status      String   @default("PENDING") // PENDING, APPROVED, REJECTED
  rejectionReason String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@schema("contracts")
}

model Milestone {
  id          String   @id @default(uuid())
  description String
  amount      Decimal
  status      String   @default("PENDING") // PENDING, ACTIVE, IN_REVIEW, COMPLETED
  escrowStatus String  @default("UNFUNDED") // UNFUNDED, FUNDED, RELEASED, REFUNDED
  dueDate     DateTime?
  autoReleaseDate DateTime?
  progressPercentage Int @default(0)
  contractId  String
  contract    Contract @relation(fields: [contractId], references: [id])
  submissions Submission[]
  
  @@schema("contracts")
}
model ArbitrationCase {
  id             String   @id @default(uuid())
  contractId     String
  contract       Contract @relation(fields: [contractId], references: [id])
  status         String   @default("OPEN") // OPEN, IN_REVIEW, RESOLVED, CLOSED
  investigatorId String?  // User ID of assigned investigator
  decision       String?  // Decision text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@schema("contracts")
}

model Submission {
  id          String   @id @default(uuid())
  content     String
  attachments String[] // URLs to files
  type        String   @default("PROGRESS_REPORT") // PROGRESS_REPORT, FINAL_RESULT
  revisionCount Int      @default(0)
  createdAt   DateTime @default(now())
  milestoneId String
  milestone   Milestone @relation(fields: [milestoneId], references: [id])
  revisions   RevisionRequest[]

  @@schema("contracts")
}

model RevisionRequest {
  id            String   @id @default(uuid())
  feedback      String
  attachments   String[]
  status        String   @default("OPEN") // OPEN, ADDRESSED
  submissionId  String
  submission    Submission @relation(fields: [submissionId], references: [id])
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@schema("contracts")
}

model TimeSession {
  id          String   @id @default(uuid())
  contractId  String
  contract    Contract @relation(fields: [contractId], references: [id])
  startTime   DateTime @default(now())
  endTime     DateTime?
  description String?
  activityScore Float?   // 0-100 score based on activity
  idleMinutes   Int?     // Total idle time detected
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@schema("contracts")
}

model ContractTemplate {
  id          String   @id @default(uuid())
  clientId    String   // User ID of the client who created the template
  name        String
  description String?
  content     String   // The actual template text/markdown
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@schema("contracts")
}
