generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["multiSchema"]
  binaryTargets   = ["native", "linux-musl"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["users", "sync"]
}

model User {
  id                     String                 @id @default(uuid())
  address                String?
  addressEncrypted       String?
  avatarUrl              String?
  coverImageUrl          String?
  badges                 String[]
  banExpiresAt           DateTime?
  banReason              String?
  companyLogo            String?
  companyName            String?
  companySize            String?
  completionPercentage   Int                    @default(0)
  country                String?
  createdAt              DateTime               @default(now())
  email                  String                 @unique
  emailNotifications     Boolean                @default(true)
  firstName              String?
  googleId               String?                @unique
  hourlyRate             Decimal?
  idDocument             String?
  inAppNotifications     Boolean                @default(true)
  industry               String?
  isAvailable            Boolean                @default(true)
  isIdentityVerified     Boolean                @default(false)
  isPaymentVerified      Boolean                @default(false)
  isPromoted             Boolean                @default(false)
  jobSuccessScore        Int                    @default(100)
  kycStatus              String                 @default("PENDING")
  language               String?                @default("en")
  lastName               String?
  linkedinId             String?                @unique
linkedinUsername        String?
  overview               String?
  password               String?
  phone                  String?
  primaryCategoryId      String?
  promotionExpiresAt     DateTime?
  pushNotifications      Boolean                @default(true)
  rating                 Decimal                @default(0.0)
  resetPasswordExpiresAt DateTime?
  resetPasswordToken     String?
  reviewCount            Int                    @default(0)
  roles                  String[]               @default(["FREELANCER"])
  skills                 String[]
  status                 String                 @default("ACTIVE")
  timezone               String?                @default("UTC")
  title                  String?
  trustScore             Int                    @default(100)
  guardianRiskScore      Int                    @default(0)
  guardianFlags          String[]               @default([])
  isCloudMember          Boolean                @default(false)
  hasCloudOwnership      Boolean                @default(false)
  languages              Json?                  // e.g. [{ "lang": "English", "level": "NATIVE" }]
  twoFactorEnabled       Boolean                @default(false)
  twoFactorSecret        String?
  updatedAt              DateTime               @updatedAt
  website                String?
  referralCode           String?                @unique
  facebookId             String?                @unique
  githubId               String?                @unique
  keycloakId             String?                @unique
  isEmailVerified        Boolean                @default(false)
  taxId                  String?
  taxIdEncrypted         String?
  taxIdType              String?                // SSN, EIN, VAT
  taxVerifiedStatus      String                 @default("UNVERIFIED")
  taxFormType            String?                // W8BEN, W9
  taxSignatureName       String?
  taxSignatureDate       DateTime?
  taxSignatureIp         String?
  billingAddress         String?
  billingAddressEncrypted String?
  totalSpend             Decimal                @default(0.0)
  jobsPostedCount       Int                    @default(0)
  jobsHiredCount        Int                    @default(0)

  // Advanced KYC
  kycMethod              String?                // DOCUMENT, VIDEO
  documentData           Json?                  // Extracted OCR data
  videoInterviewAt       DateTime?
  videoInterviewLink     String?

  // Background Check
  backgroundCheckStatus      String                 @default("UNSTARTED") // UNSTARTED, PENDING, COMPLETED, REJECTED
  backgroundCheckId          String?
  backgroundCheckUrl         String?
  backgroundCheckVerifiedAt  DateTime?

  // Portfolio Platform Integration
  githubUsername         String?
  behanceUsername        String?
  dribbbleUsername       String?

  twitterUsername        String?
  portfolioSyncEnabled   Boolean                @default(false)
  lastPortfolioSync      DateTime?

  // Behavioral Metrics
  communicationStyle     String?                // Proactive, Formal, Concise, etc.
  avgResponseTime        Float?                 // in minutes
  reliabilityScore       Float                  @default(100)
  metadata               Json?                  // Generic metadata for badges/trust score
  
  // Subscription
  subscriptionTier       String                 @default("FREE") // FREE, PLUS, ENTERPRISE
  subscriptionStatus     String                 @default("ACTIVE")
  subscriptionEndsAt     DateTime?

  availability           AvailabilityCalendar[]
  education              Education[]
  experience             Experience[]
  portfolio              PortfolioItem[]
  ownedTeams             Team[]
  teams                  TeamMember[]
  profile                Profile?               @relation("UserProfile")
  referredBy             Referral?              @relation("Referred")
  referrals              Referral[]             @relation("Referrer")

  savedFreelancers       SavedFreelancer[]      @relation("ClientSaved")
  savedByClients         SavedFreelancer[]      @relation("FreelancerSaved")
  certifications         Certification[]
  employeeProfile        EmployeeProfile?
  assessments           SkillAssessment[]

  identityVerifications IdentityVerification[]
  trustedDevices          TrustedDevice[]

  awardedBadges           Badge[]
  specializedProfiles     SpecializedProfile[]

  @@map("users")
  @@schema("users")
}

model Badge {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  name        String   // TOP_RATED, RISING_TALENT, EXPERT_VETTED
  slug        String
  iconUrl     String?
  awardedAt   DateTime @default(now())
  expiresAt   DateTime?
  metadata    Json?

  @@unique([userId, name])
  @@schema("users")
}

model IdentityVerification {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id])
  provider      String   // SUMSUB, ONFIDO
  status        String   @default("PENDING") // PENDING, VERIFIED, REJECTED
  transactionId String?
  data          Json?    // Provider specific data
  videoUrl      String?  // For Video KYC
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@schema("users")
}

model TrustedDevice {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  deviceId    String   // Fingerprint hash
  deviceName  String?
  lastLoginAt DateTime @default(now())
  trustScore  Int      @default(100)
  isBlocked   Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([userId, deviceId])
  @@schema("users")
}

model EmployeeProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  jobTitle        String
  startDate       DateTime
  taxStatus       String   @default("W2") // W2, 1099, C2C
  benefitsPackage String   @default("BASIC") // BASIC, PREMIUM, NONE
  dependentsCount Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  user            User     @relation(fields: [userId], references: [id])

  @@schema("users")
}

model Certification {
  id              String   @id @default(uuid())
  userId          String
  title           String
  issuer          String   // Credly, HackerRank, LinkedIn
  issuerId        String
  verificationUrl String
  status          String   @default("PENDING") // PENDING, VERIFIED, REJECTED
  verifiedAt      DateTime?
  metadata        Json?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  specializedProfileId String?
  specializedProfile   SpecializedProfile? @relation(fields: [specializedProfileId], references: [id])

  @@schema("users")
}

model SkillAssessment {
  id              String   @id @default(uuid())
  userId          String
  skillName       String
  questions       Json?    // Array of { question: string, type: string }
  answers         Json?    // Map of question to answer
  score           Int?
  status          String   @default("PENDING") // PENDING, COMPLETED, FAILED
  verifiedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])

  @@schema("users")
}

model Profile {
  id                String   @id @default(uuid())
  userId            String   @unique
  headline          String?
  bio               String?
  hourlyRate        Decimal?
  skills            String[]
  primaryCategoryId String?
  isComplete        Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  user              User     @relation("UserProfile", fields: [userId], references: [id])

  @@map("profiles")
  @@schema("users")
}

model Referral {
  id           String   @id @default(uuid())
  referrerId   String
  referredId   String   @unique
  status       String   @default("PENDING")
  rewardAmount Decimal  @default(0.0)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  referred     User     @relation("Referred", fields: [referredId], references: [id])
  referrer     User     @relation("Referrer", fields: [referrerId], references: [id])

  @@map("referrals")
  @@schema("users")
}

model AvailabilityCalendar {
  id        String   @id @default(uuid())
  userId    String
  date      DateTime
  isBusy    Boolean  @default(true)
  note      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, date])
  @@schema("users")
}

model Education {
  id           String    @id @default(uuid())
  institution  String
  degree       String
  fieldOfStudy String
  startDate    DateTime
  endDate      DateTime?
  description  String?
  userId       String
  user         User      @relation(fields: [userId], references: [id])
  specializedProfileId String?
  specializedProfile   SpecializedProfile? @relation(fields: [specializedProfileId], references: [id])
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@schema("users")
}

model Experience {
  id          String    @id @default(uuid())
  company     String
  title       String
  location    String?
  startDate   DateTime
  endDate     DateTime?
  current     Boolean   @default(false)
  description String?
  userId      String
  user        User      @relation(fields: [userId], references: [id])
  specializedProfileId String?
  specializedProfile   SpecializedProfile? @relation(fields: [specializedProfileId], references: [id])
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@schema("users")
}

model PortfolioItem {
  id             String    @id @default(uuid())
  title          String
  description    String?
  imageUrl       String
  projectUrl     String?
  skills         String[]
  completionDate DateTime?
  source         String    @default("MANUAL") // MANUAL, GITHUB, BEHANCE, DRIBBBLE, AI_GENERATED
  isVerified     Boolean   @default(false)
  verificationScore Int?
  aiFeedback     String?
  externalId     String?
  externalUrl    String?
  userId         String
  user           User      @relation(fields: [userId], references: [id])
  specializedProfileId String?
  specializedProfile   SpecializedProfile? @relation(fields: [specializedProfileId], references: [id])
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@schema("users")
}

model SpecializedProfile {
  id                String   @id @default(uuid())
  userId            String
  user              User     @relation(fields: [userId], references: [id])
  headline          String?
  bio               String?
  hourlyRate        Decimal?
  skills            String[]
  primaryCategoryId String?
  isDefault         Boolean  @default(false)
  portfolioItems    PortfolioItem[]
  education         Education[]
  experience        Experience[]
  certifications    Certification[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@schema("users")
}

model Team {
  id          String       @id @default(uuid())
  name        String
  description String?
  logoUrl     String?
  ownerId     String
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  owner       User         @relation(fields: [ownerId], references: [id])
  members     TeamMember[]
  policies    ApprovalPolicy[]
  departments Department[]
  ssoConfig   SSOConfig?
  clauses     ContractClause[]

  @@schema("users")
}

model ContractClause {
  id        String   @id @default(uuid())
  teamId    String
  team      Team     @relation(fields: [teamId], references: [id])
  title     String
  content   String
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("users")
}

model SSOConfig {
  id        String   @id @default(uuid())
  teamId    String   @unique
  team      Team     @relation(fields: [teamId], references: [id])
  domain    String   @unique // e.g. "acme.com"
  isEnabled Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@schema("users")
}

model ApprovalPolicy {
  id            String   @id @default(uuid())
  teamId        String
  team          Team     @relation(fields: [teamId], references: [id])
  triggerType   String   // HIRE, PAYMENT
  minAmount     Decimal? 
  requiredRoles String[] // e.g. ["MANAGER", "ADMIN"]
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([teamId, triggerType])
  @@schema("users")

}

model Department {
  id          String   @id @default(uuid())
  teamId      String
  team        Team     @relation(fields: [teamId], references: [id])
  name        String
  code        String?
  budget      Decimal? // Optional budget cap
  spent       Decimal  @default(0.0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([teamId, name])
  @@schema("users")
}

model TeamMember {
  id        String   @id @default(uuid())
  teamId    String
  userId    String
  role      String   @default("MEMBER")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  team      Team     @relation(fields: [teamId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@unique([teamId, userId])
  @@schema("users")
}

model SavedFreelancer {
  id           String   @id @default(uuid())
  clientId     String
  freelancerId String
  note         String?
  tags         String[]
  createdAt    DateTime @default(now())

  client       User     @relation("ClientSaved", fields: [clientId], references: [id])
  freelancer   User     @relation("FreelancerSaved", fields: [freelancerId], references: [id])

  @@unique([clientId, freelancerId])
  @@schema("users")
}

model SyncTombstone {
  id        String   @id @default(uuid())
  entity    String   // e.g., "User", "PortfolioItem"
  recordId  String
  userId    String?  // Optional: associated user
  deletedAt DateTime @default(now())
  
  @@index([entity, deletedAt, userId])
  @@map("sync_tombstones")
  @@schema("sync")
}
